<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>wordpress漏洞-cve-2022-21661-原理及复现</title>
    <url>/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="0x01-原理"><a href="#0x01-原理" class="headerlink" title="0x01  原理"></a>0x01  原理</h2><p>　<code>利用条件：① wordpress &lt;=5.8.2</code></p>
<p> 　　　　　　<code>② 插件中存在wp_query调用且参数可控。</code></p>
<p>　　此次漏洞触发点位于 <code>“class-wp-tax-query.php”</code>文件中的 <code>“clean_query”</code>函数，通过传入特定参数，根据函数逻辑，可使函数<code>transform_query</code>不经处理直接逃逸返回，从而造成sql注入，以下是漏洞调用链分析<span id="more"></span>：</p>
<p>　　在<code>clean_query</code>函数中，使<code>$query[‘field’]</code>的取值为<code>‘term_taxonomy_id’</code>，并且<code>$query[‘include_children’]==false</code>或<code>is_taxonomy_hierarchical($query[‘taxonomy’]) ==false</code>即可跳过下图中的<code>if</code>判断，进入<code>transform_query</code>函数<!--more-->：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314142117659.png" alt="image-20220314142117659"></p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314142126887.png" alt="image-20220314142126887"></p>
<p>　　在<code>transform_query</code>函数中，由于我们提前传入了参数<code>$query[‘field’]== ‘term_taxonomy_id’</code>，因此该函数会不经处理直接返回：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314144653960.png" alt="image-20220314144653960"></p>
<p>　　由于<code>clean_query</code>函数是由<code>get_sql_for_clause</code>调用的，在<code>transform_query</code>函数逃逸返回后，变量<code>$query[‘term’]</code>将拼接查询条件作为<code>sql</code>的查询语句，从而引发<code>sql</code>注入：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314144727304.png" alt="image-20220314144727304"></p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314144732504.png" alt="image-20220314144732504"></p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314144736232.png" alt="image-20220314144736232"></p>
<p>　　此错误是<code>wp</code>核心调用的漏洞，但是<code>wp</code>核心的复用方式（<code>wp</code>自身调用<code>wp_query</code>）的共205处调用均未满足条件，故可在<code>wp</code>的插件&#x2F;主题中寻找符合条件的<code>WP_Query</code>函数来触发漏洞。</p>
<p><font color="red"><strong>FAQ：根据上述开篇讲到的，为什么漏洞是</strong><code>clean_query</code><strong>函数造成的，却要调用</strong><code>WP_Query</code><strong>来造成漏洞触发？</strong></font></p>
<p>　　这个是由<code>clean_query</code>函数的调用链决定的，经过调试溯源，可发现漏洞函数<code>clean_query</code>的最原始调用函数为<code>WP_Query</code>，这个可通过函数的调用栈看出：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314145241051.png" alt="image-20220314145241051"></p>
<p>此函数的整个调用链如下：</p>
<p>WP_Query#__construct -&gt; WP_Query#query-&gt; WP_Query#get_posts -&gt;WP_Tax_Query#get_sql -&gt;WP_Tax_Query#get_sql_clauses-&gt;WP_Tax_Query#get_sql_for_query-&gt;WP_Tax_Query#get_sql_for_clause </p>
<p>　　在插件&#x2F;主题中调用<code>wp</code>核心函数<code>WP_Query</code>还涉及一个知识点，由于<code>wp</code>具有<code>ajax</code>异步调用请求接口，且插件&#x2F;主题调用<code>wp</code>核心函数时均使用该方法实现，故还需理解<code>wp</code>的<code>ajax</code>调用原理：</p>
<p>　　<font color="red"><em>WordPress的AJAX请求统一通过&#x2F;wp-admin&#x2F;admin-ajax.php这个URL来提交AJAX请求。通过在提交的FORM表单中添加action参数来获取在后台注册的AJAX处理函数。wp_ajax_{$action}或者wp_ajax_nopriv_{$action}中的{$action}就是前端AJAX请求时要提交的action参数内容。</em></font></p>
<p>　　也就是说，如果<code>ajax</code>请求 <code>http://域名/wp-admin/admin-ajax.php</code>，无论<code>action</code>参数是通过<code>post</code>或<code>get</code>方式传递的，<code>admin-ajax</code>都会去查找并执行对应的处理代码，这个可以从<code>wp</code>中的<code>admin-ajax.php</code>源码中看出：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314145429979.png" alt="image-20220314145429979"></p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314145433672.png" alt="image-20220314145433672"></p>
<p><font color="red"><strong>FAQ：</strong><code>wp_ajax_&#123;$action&#125;</code><strong>和</strong><code>wp_ajax_nopriv_&#123;$action&#125;</code><strong>之间有什么区别？</strong></font></p>
<p>　　<code>wp_ajax_&#123;$action&#125;</code> 是用户登录后所提交的<code>AJAX</code>处理函数，而<code>wp_ajax_nopriv_&#123;$action&#125;</code>是未登录用户的<code>AJAX</code>请求处理函数。意思为若插件&#x2F;主题代码中注册了<code>wp_ajax_nopriv_&#123;$action&#125;</code>函数，可无需登录直接调用对应的<code>ajax</code>请求。</p>
<h2 id="0x02-复现"><a href="#0x02-复现" class="headerlink" title="0x02 复现"></a>0x02 复现</h2><p>　　方便起见，直接在现有代码基础上构造触发漏洞的函数代码测试（实际环境可通过wp官网下载插件源码寻找测试）。</p>
<p>1.在<code>wp</code>的<code>“twentytwenty”</code>主题的<code>“function.php”</code>中添加无需用户登录的<code>ajax</code>调用请求代码：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314145749257.png" alt="image-20220314145749257"></p>
<ol start="2">
<li>由于此<code>sql</code>注入默认无回显，测试环境需开启<code>wp</code>的<code>debug</code>模式使其输出错误信息方便观察：</li>
</ol>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314145824552.png" alt="image-20220314145824552"></p>
<p>3.抓包输入<code>payload</code>：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314145854649.png" alt="image-20220314145854649"></p>
<p>4.调试中的<code>sql</code>查询语句如下：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314145918553.png" alt="image-20220314145918553"></p>
<p>5.数据回显：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20220314145930120.png" alt="image-20220314145930120"></p>
<p>　　以上是开启了<code>wp</code>的<code>debug</code>模式测试的，真实环境默认不回显，可使用盲注或通过<code>dnslog/ceye</code>外带数据。</p>
<p>6.通过审计发现某插件存在注入漏洞，经过调试参数，修改payload结果如下：</p>
<p><img src="/2022/03/14/wordpress%E6%BC%8F%E6%B4%9E-cve-2022-21661-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%8D%E7%8E%B0/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220215115431-1-1024x525.png" alt="微信图片_20220215115431-1-1024x525"></p>
<hr>
]]></content>
      <categories>
        <category>漏洞复现</category>
      </categories>
  </entry>
</search>
